pipeline {
    agent any
    
    environment {
        PROYECT_JIRA = "AJI"
        TITULO_JIRA = "Creación de Instancia base de datos Oracle"
        ID_ISSUETYPE_JIRA = "14898"
        // GCP_CREDENTIALS = credentials('gcp-sa-platform')
        JIRA_API_URL = 'https://bancoripley1.atlassian.net/rest/api/3/issue/'
        // GCP_CREDENTIALS =
        JIRA_USER = 'lucas.a.gomez@accenture.com'
        TOKEN_JIRA = credentials('JIRA_TOKEN')
        // Configuración del país y proveedor
        PAIS = 'PE'
        DB_SERVICE_PROVIDER = 'GCP - Cloud SQL'
        DB_ENGINE = 'OracleSQL'
        
        // Configuración de backup y zona horaria
        DB_BACKUP_ENABLED = 'true'
        DB_TIME_ZONE = 'UTC-0'
        
        // Etiquetas y tags
        DB_RESOURCE_LABELS = 'test'
        DB_TAGS = 'test'
        
        // Credenciales de plataforma
        DB_PLATFORM_USER = 'Equipo_plataforma'
        DB_PLATFORM_PASS = 'password'
        
        // Credenciales de administrador
        DB_USER_ADMIN = 'OracleSQL'
        DB_PASSWORD_ADMIN = 'password'
    }
    
    parameters {

        // ========================================
        // CONFIGURACIÓN DE PROYECTO GCP
        // ========================================
        string(
            name: 'PROJECT_ID', 
            defaultValue: 'jenkins-terraform-demo-472920', 
            description: 'ID del proyecto en Google Cloud Platform'
        )
        string(
            name: 'DB_INSTANCE_NAME', 
            defaultValue: 'instacia-oracle', 
            description: 'Nombre de la instacia'
        )
        string(
            name: 'REGION', 
            defaultValue: 'us-central1', 
            description: 'Región de GCP (ejemplo: us-central1, southamerica-west1)'
        )
        string(
            name: 'ZONE', 
            defaultValue: 'us-central1-a', 
            description: 'Zona de disponibilidad (ejemplo: us-central1-a)'
        )
        choice(
            name: 'ENVIRONMENT', 
            choices: ['desarrollo', 'pre productivo', 'productivo'], 
            description: 'Ambiente de despliegue'
        )
        
        // ========================================
        // CONFIGURACIÓN DE BASE DE DATOS
        // ========================================
        choice(
            name: 'DB_VERSION', 
            choices: ['19c', '12c', '11g'], 
            description: 'Versión de Oracle Database'
        )
        string(
            name: 'DB_NAME', 
            defaultValue: 'orcl', 
            description: 'Nombre de la base de datos'
        )
        string(
            name: 'DB_SID', 
            defaultValue: 'ORCL', 
            description: 'System Identifier (SID) de Oracle'
        )
        string(
            name: 'DB_CHARACTER_SET', 
            defaultValue: 'AL32UTF8', 
            description: 'Character Set de la base de datos (ejemplo: AL32UTF8, WE8ISO8859P1)'
        )
        string(
            name: 'DB_USERNAME', 
            defaultValue: 'admin', 
            description: 'Usuario de la base de datos'
        )
        string(
            name: 'DB_PASSWORD', 
            defaultValue: 'SuperSecreta123', 
            description: 'Contraseña del usuario de la base de datos'
        )
        string(
            name: 'DB_MAX_CONNECTIONS', 
            defaultValue: '100', 
            description: 'Número máximo de conexiones concurrentes'
        )
        choice(
            name: 'ENABLE_CACHE', 
            choices: ['false', 'true'], 
            description: 'Habilitar cache de datos en la base de datos'
        )
        
        // ========================================
        // CONFIGURACIÓN DE RECURSOS DE CÓMPUTO
        // ========================================
        choice(
            name: 'MACHINE_TYPE', 
            choices: ['db-n2-highmem-8', 'db-n1-standard-4', 'db-custom-2-3840'], 
            description: 'Tipo de máquina virtual'
        )
        
        // ========================================
        // CONFIGURACIÓN DE ALMACENAMIENTO
        // ========================================
        string(
            name: 'DB_STORAGE_SIZE', 
            defaultValue: '100', 
            description: 'Tamaño del almacenamiento en GB'
        )
        choice(
            name: 'DB_STORAGE_TYPE', 
            choices: ['SSD', 'Balanced', 'HDD'], 
            description: 'Tipo de disco de almacenamiento'
        )
        choice(
            name: 'DB_STORAGE_AUTO_RESIZE', 
            choices: ['true', 'false'], 
            description: 'Habilitar redimensionamiento automático del almacenamiento'
        )
        string(
            name: 'BOOT_DISK_TYPE', 
            defaultValue: 'pd-ssd', 
            description: 'Tipo de disco de arranque (pd-ssd, pd-standard, pd-balanced)'
        )
        string(
            name: 'BOOT_DISK_SIZE', 
            defaultValue: '50', 
            description: 'Tamaño del disco de arranque en GB'
        )
        string(
            name: 'OS_IMAGE', 
            defaultValue: 'projects/oracle-cloud/global/images/oracle-db-19c', 
            description: 'Imagen del sistema operativo'
        )
        
        // ========================================
        // CONFIGURACIÓN DE RED
        // ========================================
        string(
            name: 'VPC_NETWORK', 
            defaultValue: 'default', 
            description: 'Nombre de la red VPC'
        )
        string(
            name: 'SUBNET', 
            defaultValue: 'default', 
            description: 'Subred dentro de la VPC'
        )
        choice(
            name: 'DB_PRIVATE_IP_ENABLED', 
            choices: ['true', 'false'], 
            description: 'Habilitar dirección IP privada'
        )
        choice(
            name: 'DB_PUBLIC_ACCESS_ENABLED', 
            choices: ['false', 'true'], 
            description: 'Habilitar acceso público a la base de datos'
        )
        choice(
            name: 'DB_IP_RANGE_ALLOWED', 
            choices: ['false', 'true'], 
            description: 'Configurar rangos de IP permitidos'
        )
        
        // ========================================
        // CONFIGURACIÓN DE SEGURIDAD
        // ========================================
        choice(
            name: 'DB_SSL_ENABLED', 
            choices: ['true', 'false'], 
            description: 'Requerir conexiones SSL/TLS'
        )
        choice(
            name: 'DB_ENCRYPTION_ENABLED', 
            choices: ['true', 'false'], 
            description: 'Habilitar encriptación de datos en reposo'
        )
        choice(
            name: 'DB_DELETION_PROTECTION', 
            choices: ['true', 'false'], 
            description: 'Protección contra eliminación accidental'
        )
        string(
            name: 'IAM_ROLE', 
            defaultValue: 'terraform-sa@jenkins-terraform-demo-472920.iam.gserviceaccount.com', 
            description: 'Rol de IAM para la instancia de base de datos'
        )
        choice(
            name: 'CREDENTIAL_FILE', 
            choices: ['false', 'true'], 
            description: 'Utilizar archivo de credenciales para autenticación'
        )
        
        // ========================================
        // CONFIGURACIÓN DE BACKUP
        // ========================================
        string(
            name: 'BACKUP_RETENTION_DAYS', 
            defaultValue: '7', 
            description: 'Días de retención de backups automáticos'
        )
        string(
            name: 'DB_BACKUP_START_TIME', 
            defaultValue: '02:00', 
            description: 'Hora de inicio de backup diario (formato HH:MM)'
        )
        
        // ========================================
        // CONFIGURACIÓN DE MANTENIMIENTO
        // ========================================
        string(
            name: 'DB_MAINTENANCE_WINDOW_DAY', 
            defaultValue: 'sunday', 
            description: 'Día de la ventana de mantenimiento (ejemplo: sunday, monday)'
        )
        choice(
            name: 'DB_MAINTENANCE_WINDOW_HOUR', 
            choices: ['02:00', '03:00', '04:00'], 
            description: 'Hora de inicio de la ventana de mantenimiento'
        )
        
        // ========================================
        // CONFIGURACIÓN DE MONITOREO
        // ========================================
        choice(
            name: 'DB_MONITORING_ENABLED', 
            choices: ['true', 'false'], 
            description: 'Habilitar monitoreo avanzado con Cloud Monitoring'
        )
        
        // ========================================
        // ALTA DISPONIBILIDAD Y ESCALABILIDAD
        // ========================================
        choice(
            name: 'DB_HIGH_AVAILABILITY', 
            choices: ['false', 'true'], 
            description: 'Habilitar configuración de alta disponibilidad (HA)'
        )
        choice(
            name: 'AUTO_SCALE_ENABLED', 
            choices: ['false', 'true'], 
            description: 'Habilitar auto escalado de recursos'
        )
        string(
            name: 'DB_LISTENER_CONFIG', 
            defaultValue: '', 
            description: 'Configuración personalizada del Oracle Listener'
        )
        
        // ========================================
        // OPCIONES ADMINISTRATIVAS
        // ========================================
        choice(
            name: 'CHECK_DELETE', 
            choices: ['false', 'true'], 
            description: 'Habilitar verificación antes de eliminar recursos'
        )
        choice(
            name: 'ACTION', 
            choices: ['plan', 'apply', 'distroy'], 
            description: 'Acción a seguir'
        )
        string(
            name: 'TICKET_JIRA', 
            defaultValue: 'AJI-1', 
            description: 'Numero de ticket jira'
        )
    }
    
    stages {
        stage('Validacion de Variables') {
            steps {
                script {
                    echo "Validando el ambiente: ${params.ENVIRONMENT}"

                    env.DB_BACKUP_ENABLED = params.DB_BACKUP_ENABLED
                    echo "Valor inicial de DB_BACKUP_ENABLED (seleccionado por usuario): ${env.DB_BACKUP_ENABLED}"

                    if (params.ENVIRONMENT == 'Produccion') {
                        if (env.DB_BACKUP_ENABLED == 'false') {
                            echo "ADVERTENCIA: Ambiente de Producción detectado. Se forzará DB_BACKUP_ENABLED a 'true'."
                            env.DB_BACKUP_ENABLED = 'true'
                        } else {
                            echo "Validación OK: Ambiente de Producción. DB_BACKUP_ENABLED ya está en 'true'."
                        }
                    } else if (params.ENVIRONMENT == 'Desarrollo' || params.ENVIRONMENT == 'Pre-productivo (PP)') {
                        echo "Ambiente de Desarrollo/Pre-productivo. Se respeta el valor de DB_BACKUP_ENABLED: ${env.DB_BACKUP_ENABLED}"
                    } else {
                        error("ERROR CRÍTICO: Ambiente de despliegue no válido: ${params.ENVIRONMENT}")
                    }
                }
            }
        }
        
    
        stage('Capturar Configuración'){
            steps{
                script{
                     def configuracionOculta = [
                        'País': env.PAIS,
                        'Proveedor de Servicio': env.DB_SERVICE_PROVIDER,
                        'Motor de Base de Datos': env.DB_ENGINE,
                        'Backup Habilitado': env.DB_BACKUP_ENABLED,
                        'Zona Horaria': env.DB_TIME_ZONE,
                        'Etiquetas de Recursos': env.DB_RESOURCE_LABELS,
                        'Tags': env.DB_TAGS,
                        'Usuario de Plataforma': env.DB_PLATFORM_USER,
                        'Usuario Administrador': env.DB_USER_ADMIN
                    ]

                    def configuracionGCP = [
                        'Ticket Jira' : params.TICKET_JIRA,
                        'Acción a realizar' : params.ACTION,
                        'ID de Proyecto': params.PROJECT_ID,
                        'Nombre de la instacia': params.DB_INSTANCE_NAME,
                        'Región': params.REGION,
                        'Zona': params.ZONE,
                        'Ambiente': params.ENVIRONMENT
                    ]
                    
                    def configuracionBaseDatos = [
                        'Versión de Oracle': params.DB_VERSION,
                        'Nombre de BD': params.DB_NAME,
                        'SID': params.DB_SID,
                        'Character Set': params.DB_CHARACTER_SET,
                        'Usuario de BD': params.DB_USERNAME,
                        'Conexiones Máximas': params.DB_MAX_CONNECTIONS,
                        'Habilitar cache de datos': params.ENABLE_CACHE
                    ]
                    
                    def configuracionRecursos = [
                        'Tipo de Máquina': params.MACHINE_TYPE,
                        'Tamaño de Almacenamiento': "${params.DB_STORAGE_SIZE} GB",
                        'Tipo de Almacenamiento': params.DB_STORAGE_TYPE,
                        'Auto Resize': params.DB_STORAGE_AUTO_RESIZE,
                        'Tipo de Disco de Arranque': params.BOOT_DISK_TYPE,
                        'Tamaño de Disco de Arranque': "${params.BOOT_DISK_SIZE} GB"
                    ]
                    
                    def configuracionRed = [
                        'Red VPC': params.VPC_NETWORK,
                        'Subred': params.SUBNET,
                        'IP Privada': params.DB_PRIVATE_IP_ENABLED,
                        'Acceso Público': params.DB_PUBLIC_ACCESS_ENABLED,
                        'Rangos IP Permitidos': params.DB_IP_RANGE_ALLOWED,
                        'SSL Habilitado': params.DB_SSL_ENABLED
                    ]
                    
                    def configuracionSeguridad = [
                        'Encriptación': params.DB_ENCRYPTION_ENABLED,
                        'Protección contra Eliminación': params.DB_DELETION_PROTECTION,
                        'Rol IAM': params.IAM_ROLE,
                        'Archivo de Credenciales': params.CREDENTIAL_FILE
                    ]
                    
                    def configuracionBackup = [
                        'Días de Retención': params.BACKUP_RETENTION_DAYS,
                        'Hora de Inicio': params.DB_BACKUP_START_TIME,
                        'Día de Mantenimiento': params.DB_MAINTENANCE_WINDOW_DAY,
                        'Hora de Mantenimiento': params.DB_MAINTENANCE_WINDOW_HOUR
                    ]
                    
                    def configuracionAltaDisponibilidad = [
                        'Alta Disponibilidad': params.DB_HIGH_AVAILABILITY,
                        'Auto Escalado': params.AUTO_SCALE_ENABLED,
                        'Monitoreo Avanzado': params.DB_MONITORING_ENABLED,
                        'Configuración de Listener': params.DB_LISTENER_CONFIG
                    ]

                    
                // Guardar todo en un solo objeto JSON para reutilizar
                    env.CONFIG_JSON = groovy.json.JsonOutput.toJson([
                        configuracionOculta: configuracionOculta,
                        configuracionGCP: configuracionGCP,
                        configuracionBaseDatos: configuracionBaseDatos,
                        configuracionRecursos: configuracionRecursos,
                        configuracionRed: configuracionRed,
                        configuracionSeguridad: configuracionSeguridad,
                        configuracionBackup: configuracionBackup,
                        configuracionAltaDisponibilidad: configuracionAltaDisponibilidad,
                    ])

                }
            }
        }
        stage('Mostrar Configuración') {
            steps {
                script {

                    def config = new groovy.json.JsonSlurper().parseText(env.CONFIG_JSON)
                    def capturarParametros = ""
                    
                    
                    capturarParametros += '\n================================================\n'
                    capturarParametros +=  '\n      CONFIGURACIÓN PREDETERMINADA (OCULTA)    \n'
                    capturarParametros +=  '\n================================================\n'
                    config.configuracionOculta.each { k, v -> capturarParametros +=  " \n ${k}: ${v} \n" }
                    
                    capturarParametros +=  '\n================================================\n'
                    capturarParametros +=  '\n           CONFIGURACIÓN DE GCP                \n'
                    capturarParametros +=  '\n================================================\n'
                    config.configuracionGCP.each { k, v -> capturarParametros +=  " \n ${k}: ${v}\n" }
                    
                    capturarParametros +=  '\n================================================\n'
                    capturarParametros +=  '\n        CONFIGURACIÓN DE BASE DE DATOS         \n'
                    capturarParametros +=  '\n================================================\n'
                    config.configuracionBaseDatos.each { k, v -> capturarParametros +=  "\n  ${k}: ${v}\n" }
                    
                    capturarParametros +=  '\n================================================\n'
                    capturarParametros +=  '\n         CONFIGURACIÓN DE RECURSOS             \n'
                    capturarParametros +=  '\n================================================\n'
                    config.configuracionRecursos.each { k, v -> capturarParametros +=  "\n  ${k}: ${v}\n" }
                    
                    capturarParametros +=  '\n================================================\n'
                    capturarParametros +=  ' \n           CONFIGURACIÓN DE RED               \n'
                    capturarParametros +=  '\n================================================\n'
                    config.configuracionRed.each { k, v -> capturarParametros +=  "\n  ${k}: ${v}\n" }
                    
                    capturarParametros +=  '\n================================================\n'
                    capturarParametros +=  '\n         CONFIGURACIÓN DE SEGURIDAD            \n'
                    capturarParametros +=  '\n===============================================\n'
                    config.configuracionSeguridad.each { k, v -> capturarParametros +=  "\n  ${k}: ${v}\n" }
                    
                    capturarParametros +=  '\n================================================\n'
                    capturarParametros +=  '\n        CONFIGURACIÓN DE BACKUP Y MANTENIMIENTO\n'
                    capturarParametros +=  '\n================================================\n'
                    config.configuracionBackup.each { k, v -> capturarParametros +=  "\n ${k}: ${v}\n" }
                    
                    capturarParametros +=  '\n================================================\n'
                    capturarParametros +=  '\n    CONFIGURACIÓN DE ALTA DISPONIBILIDAD       \n'
                    capturarParametros +=  '\n================================================\n'
                    config.configuracionAltaDisponibilidad.each { k, v -> capturarParametros +=  "\n  ${k}: ${v}\n" }
                    
                    echo "${capturarParametros}"

                    

                }
            }
        }
        stage("Mensaje para teams"){
            steps{
                script{
                    def sectionMessage = """ 
                    "sections": [{
                    "activityTitle": "Nueva Instancia Oracle en Proceso de Creación",
                    "activitySubtitle": "Ticket Jira: ${params.TICKET_JIRA}",
                    "facts": [
                        {
                            "name": "Pais",
                            "value": "${env.PAIS}"
                        },
                        {
                            "name": "Ambiente",
                            "value": "${params.ENVIRONMENT}"
                        },
                        {
                            "name": "Base de Datos",
                            "value": "${params.DB_NAME} (${params.DB_VERSION})"
                        },
                        {
                            "name": "Proyecto GCP",
                            "value": "${params.PROJECT_ID}"
                        },
                        {
                            "name": "Nombre de la instacia",
                            "value": "${params.DB_INSTANCE_NAME}"
                        },
                        {
                            "name": "Región/Zona",
                            "value": "${params.REGION}/${params.ZONE}"
                        },
                        {
                            "name": "Tipo de Máquina",
                            "value": "${params.MACHINE_TYPE}"
                        },
                        {
                            "name": "Almacenamiento",
                            "value": "${params.DB_STORAGE_SIZE} GB (${params.DB_STORAGE_TYPE})"
                        },
                        {
                            "name": "Alta Disponibilidad",
                            "value": "${params.DB_HIGH_AVAILABILITY}"
                        }
                    ],
                    "markdown": true
                }],
                "potentialAction": [
                    {
                        "@type": "OpenUri",
                        "name": "Ver Build",
                        "targets": [
                            {
                                "os": "default",
                                "uri": "${env.BUILD_URL}"
                            }
                        ]
                    }
                ]
                                    
                """
                    env.mensajeTeams = sectionMessage
                }
            }
        }

        stage("descripción Jira"){
            steps{
                script{
                    
                    def notificationText = """
                    Pais : ${env.PAIS}
                    Instancia: ${params.DB_INSTANCE_NAME ?: 'N/A'}
                    Ambiente: ${params.ENVIRONMENT}
                    Acción: ${params.ACTION}
                    Proyecto GCP: ${params.PROJECT_ID}
                    Región/Zona: ${params.REGION} / ${params.ZONE}

                    Base de datos:
                    - Nombre: ${params.DB_NAME}
                    - SID: ${params.DB_SID}
                    - Versión: ${params.DB_VERSION}
                    - Charset: ${params.DB_CHARACTER_SET}
                    - Usuario: ${params.DB_USERNAME}
                    - Máx conexiones: ${params.DB_MAX_CONNECTIONS}

                    Recursos:
                    - Máquina: ${params.MACHINE_TYPE}
                    - Almacenamiento: ${params.DB_STORAGE_SIZE} GB (${params.DB_STORAGE_TYPE})
                    - Auto-resize: ${params.DB_STORAGE_AUTO_RESIZE}

                    Red y acceso:
                    - VPC/Subnet: ${params.VPC_NETWORK} / ${params.SUBNET}
                    - IP Privada: ${params.DB_PRIVATE_IP_ENABLED}
                    - Acceso Público: ${params.DB_PUBLIC_ACCESS_ENABLED}
                    - SSL: ${params.DB_SSL_ENABLED}

                    Seguridad:
                    - Encriptación: ${params.DB_ENCRYPTION_ENABLED}
                    - Protección eliminación: ${params.DB_DELETION_PROTECTION}
                    - IAM Role: ${params.IAM_ROLE}

                    Backup / Mantenimiento:
                    - Retención (días): ${params.BACKUP_RETENTION_DAYS}
                    - Backup start: ${params.DB_BACKUP_START_TIME}
                    - Ventana mantenimiento: ${params.DB_MAINTENANCE_WINDOW_DAY} ${params.DB_MAINTENANCE_WINDOW_HOUR}

                    Alta disponibilidad / Monitoreo:
                    - HA: ${params.DB_HIGH_AVAILABILITY}
                    - Auto-scale: ${params.AUTO_SCALE_ENABLED}
                    - Monitoring: ${params.DB_MONITORING_ENABLED}
                    """

                    env.mensaje = notificationText
                }
            }
        }
        


       
        // stage('Validar y Transicionar Ticket Jira') {
        //     steps {
        //         script {
        //             withCredentials([usernamePassword(credentialsId: 'JIRA_TOKEN', usernameVariable: 'JIRA_USER', passwordVariable: 'JIRA_API_TOKEN')]) {
        //                 echo "Consultando estado actual del ticket ${TICKET_JIRA}..."
        
        //                 def estado = sh(
        //                     script: """bash -c ' curl -s -u "$JIRA_USER:$JIRA_API_TOKEN" \
        //                     -X GET "${JIRA_API_URL}${TICKET_JIRA}" \
        //                     -H "Accept: application/json" \
        //                     | jq -r ".fields.status.name // \\"Desconocido\\"" '""",
        //                     returnStdout: true
        //                 ).trim()
        
        //                 echo "Estado actual: ${estado}"
        
        //                 // IDs de transición Jira
        //                 def transiciones = [
        //                     "Tareas por hacer": "31" // directo a Done
        //                 ]
        
        //                 // Guardar estado para siguiente stage
        //                 env.ESTADO_TICKET = estado
        
        //                 if (estado == "Tareas por hacer") {
        //                     def transitionId = transiciones[estado]
        //                     def mensajeJira = "El ticket ${TICKET_JIRA} fue cerrado automáticamente por ejecución del pipeline."
        
        //                     echo "Transicionando ticket ${TICKET_JIRA} a 'Done'..."
        
        //                     // Realizar transición
        //                     def payloadTrans = groovy.json.JsonOutput.toJson([transition: [id: transitionId]])
        //                     writeFile file: 'transicion.json', text: payloadTrans
        //                     sh """curl -s -u "$JIRA_USER:$JIRA_API_TOKEN" \
        //                     -X POST -H "Content-Type: application/json" \
        //                     --data @transicion.json \
        //                     "${JIRA_API_URL}${TICKET_JIRA}/transitions" """
        
        //                     // Agregar comentario en Jira
        //                     def comentario = groovy.json.JsonOutput.toJson([
        //                         body: [
        //                             type: "doc",
        //                             version: 1,
        //                             content: [[
        //                                 type: "paragraph",
        //                                 content: [[type: "text", text: mensajeJira]]
        //                             ]]
        //                         ]
        //                     ])
        //                     writeFile file: 'comentario.json', text: comentario
        //                     sh """curl -s -u "$JIRA_USER:$JIRA_API_TOKEN" \
        //                     -X POST -H "Content-Type: application/json" \
        //                     --data @comentario.json \
        //                     "${JIRA_API_URL}${TICKET_JIRA}/comment" """
        
        //                     echo "Ticket ${TICKET_JIRA} transicionado exitosamente a Done."
        
        //                 } else if (estado in ["Done", "Finalizado"]) {
        //                     error("El ticket ${TICKET_JIRA} ya está marcado como '${estado}'. No se puede volver a transicionar.")
        //                 } else {
        //                     def mensajeError = "Ticket ${TICKET_JIRA} no puede ejecutarse. Estado actual: '${estado}'. Solo se permite si está en 'Tareas por hacer'."
        //                     echo mensajeError
        
        //                     // Comentario Jira
        //                     def comentarioError = groovy.json.JsonOutput.toJson([
        //                         body: [
        //                             type: "doc",
        //                             version: 1,
        //                             content: [[
        //                                 type: "paragraph",
        //                                 content: [[type: "text", text: mensajeError]]
        //                             ]]
        //                         ]
        //                     ])
        //                     writeFile file: 'comentario_error.json', text: comentarioError
        //                     sh """curl -s -u "$JIRA_USER:$JIRA_API_TOKEN" \
        //                     -X POST -H "Content-Type: application/json" \
        //                     --data @comentario_error.json \
        //                     "${JIRA_API_URL}${TICKET_JIRA}/comment" """
        
        //                     error("Error: El estado del ticket ${TICKET_JIRA} no permitido.")
        //                 }
        //             }
        //         }
        //     }
        // }

                
        
//    stage('Notificar a Teams') {
//     steps {
//         script {
//             // Verificar si ya estaba en Done
//             if (env.ESTADO_TICKET in ["Done", "Finalizado"]) {
//                 def mensajeError = "El ticket ${TICKET_JIRA} ya estaba '${env.ESTADO_TICKET}'. No se realizó nueva transición ni despliegue."
//                 echo mensajeError

//                 def payloadError = groovy.json.JsonOutput.toJson([ text: mensajeError ])
//                 writeFile file: 'teams_error.json', text: payloadError
//                 sh "curl -s -X POST -H 'Content-Type: application/json' --data @teams_error.json ${TEAMS_WEBHOOK}"

//                 error("Pipeline detenido: ticket ya finalizado.")
//             }

//             // Mensaje con saltos de línea reales (JsonOutput se encargará de escapar)
//             def mensajeTeams = """Ticket ${TICKET_JIRA} cambió automáticamente de 'Tareas por hacer' a 'Finalizado (Done)'.

// Pipeline completado correctamente.

// Instancia de base de datos creada con los siguientes detalles:"""

//             def facts = [
//                 [ name: "Pais", value: env.PAIS ?: "" ],
//                 [ name: "Ambiente", value: params.ENVIRONMENT ?: "" ],
//                 [ name: "Base de Datos", value: "${env.DB_ENGINE} (${params.DB_VERSION})".toString() ],
//                 [ name: "Proyecto GCP", value: params.PROJECT_ID ?: "" ],
//                 [ name: "Nombre de la instancia", value: params.DB_INSTANCE_NAME ?: "" ],
//                 [ name: "Región/Zona", value: "${params.REGION}/${params.ZONE}" ],
//                 [ name: "Tipo de Máquina", value: params.MACHINE_TYPE ?: "" ],
//                 [ name: "Almacenamiento", value: "${params.DB_STORAGE_SIZE} GB (${params.DB_STORAGE_TYPE})" ],
//                 [ name: "Backup", value: params.DB_BACKUP_ENABLED ?: "" ]
//             ]

//             def card = [
//                 '@type': 'MessageCard',
//                 '@context': 'http://schema.org/extensions',
//                 text: mensajeTeams,
//                 summary: "Nueva Instancia ${env.DB_ENGINE}",
//                 themeColor: "0076D7",
//                 sections: [[
//                     activitySubtitle: "Ticket Jira: ${params.TICKET_JIRA}",
//                     facts: facts,
//                     markdown: true
//                 ]],
//                 potentialAction: [[
//                     '@type': "OpenUri",
//                     name: "Ver Build",
//                     targets: [[ os: "default", uri: env.BUILD_URL ?: "" ]]
//                 ]]
//             ]

//             def payload = groovy.json.JsonOutput.toJson(card)
//             writeFile file: 'teams_final.json', text: payload
//             sh "curl -s -X POST -H 'Content-Type: application/json' --data @teams_final.json ${TEAMS_WEBHOOK}"

//             echo "Notificación enviada a Teams con éxito."
//         }
//     }
// }

    


        stage('Crear ticket en Jira') {
            when {
                expression { params.ENVIRONMENT == 'productivo' }
                }
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'JIRA_TOKEN', usernameVariable: 'JIRA_USER', passwordVariable: 'JIRA_API_TOKEN')]) {
                        def auth = "${JIRA_USER}:${JIRA_API_TOKEN}".bytes.encodeBase64().toString()
                                                
                        // Construir el payload como mapa

                        def payloadMap = [
                            fields: [
                                project: [ key: env.PROYECT_JIRA ],
                                summary: env.TITULO_JIRA,
                                description: [
                                    type: "doc",
                                    version: 1,
                                    content: [
                                        [
                                            type: "paragraph",
                                            content: 
                                            [
                                                [ 
                                                    type: "text", text: env.mensaje ?: "Descripción no disponible" 
                                                ],                                    
                                                [
                                                    type: "text",
                                                    text: "Ver Build",
                                                    marks: [
                                                        [ type: "link", attrs: [ href: "${env.BUILD_URL}" ] ]
                                                    ]
                                                ]

                                            ]
                                        ]
                                    ],
                                
                                ],
                                issuetype: [ id: env.ID_ISSUETYPE_JIRA ]
                            ]
                        ]
                        // Convertir a JSON válido
                        def payloadJson = groovy.json.JsonOutput.toJson(payloadMap)
                        echo "${payloadJson}"
                        def response = sh(
                            script: """
                            curl -s -X POST "${JIRA_API_URL}" \\
                                -H "Authorization: Basic ${auth}" \\
                                -H "Content-Type: application/json" \\
                                -d '${payloadJson}'
                            """,
                            returnStdout: true
                        ).trim()
                        
                        echo "Comentario enviado: ${response}"
                    }
                }
            }
        }

        stage('Crear Infraestructura en GCP') {
            steps {
                script {
                    def attempt = 0
                    def success = false


                    while (attempt < env.MAX_RETRIES.toInteger() && !success) {
                        attempt++
                        echo "Intento #${attempt}: simulando creación de infraestructura..."

                        try {
                            // Simulación de fallo (puedes cambiar 'false' por otro comando que falle)
                            sh 'false'

                            echo "Simulación exitosa (esto no debería ocurrir con 'false')."
                            success = true
                        } catch (err) {
                            echo "Error en el intento #${attempt}: ${err.getMessage()}"
                            if (attempt == env.MAX_RETRIES.toInteger()) {
                                error "Simulación fallida después de ${env.MAX_RETRIES} intentos."
                            } else {
                                echo "Reintentando..."
                            }
                        }
                    } 
                }

            } 
        }
    

        
        
    }
    post {
        success { echo 'Pipeline ejecutado correctamente.' }
        failure { echo 'Error al ejecutar el pipeline.' }
    }
}
